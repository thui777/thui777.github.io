---
title: 读写锁
categories: [linux,线程]
---

-----

## 读写锁原理

在互斥锁锁定的临界区中，所有的线程只能顺序访问，无论是读操作还是写操作，极大影响执行效率，当我们只想对临界资源进行读操作时，那么线程串行读取显然不是最优的，而当对临界资源进行写操作时，这时候串行的写就尤为重要，所以在读写锁中，我们可以控制加锁方式来提高读操作的执行效率，这种锁就叫做读写锁

在linux中创建一把读写锁：

~~~c
pthread_rwlock_t rwlock;
~~~

这把锁中记录了一些信息，锁是锁定还是打开的，锁定的线程ID，锁定的是什么操作（读锁定or写锁定），同时只能有一种操作被加锁；

## 读写锁的特点

-   同一时间只有一个线程加写锁，后续有线程想加写锁必须等待写锁打开后才可以加锁，这样写锁就是串行访问
-   同一时间可以有多个线程同时加读锁，在A线程加完读锁后，B线程访问临界区时，不需要读锁解开，也能直接加读锁，这样读锁就是并行访问
-   在加完读锁之后，若后续有线程尝试加写锁，此时会阻塞，后续有线程想要加读锁时就不能直接加锁，而是阻塞起来，等待写锁线程执行完成，否则会读出脏数据

## 读写锁操作函数

#### 1.读写锁初始化

~~~c
int pthread_rwlock_init(pthread_rwlock_t *restrict rwlock,
                        const pthread_rwlockattr_t *restrict attr);
~~~

-   参数
    -   rwlock：读写锁类型变量地址
    -   attr：读写锁的属性，一般为默认属性NULL
-   返回值
    -   初始化成功返回0，失败返回错误号

#### 2.释放读写锁

~~~c
int pthread_rwlock_destroy(pthread_rwlock_t *rwlock);
~~~

-   参数
    -   rwlock：读写锁类型变量地址
-   返回值
    -   释放成功返回0，失败返回错误号

#### 3.加读锁

~~~c
int pthread_rwlock_rdlock(pthread_rwlock_t *rwlock);
~~~

-   参数
    -   rwlock：读写锁类型变量地址
-   返回值
    -   加锁成功返回0，失败返回错误号

调用这个函数，如果读写锁是打开的，那么加锁成功，如果读写锁已经锁定了读操作，依然可以加锁成功，因为读锁是共享的；但如果读写锁已经锁定了写操作，那么调用这个线程的函数就会阻塞

#### 4.尝试加读锁

~~~c
int pthread_rwlock_tryrdlock(pthread_rwlock_t *rwlock);
~~~

-   参数
    -   rwlock：读写锁类型变量地址
-   返回值
    -   加锁成功返回0，失败返回错误号

调用这个函数，如果读写锁是打开的，那么加锁成功，如果读写锁已经锁定了读操作，依然可以加锁成功，因为读锁是共享的；但如果读写锁已经锁定了写操作，那么调用这个线程的函数不会被阻塞，而是直接返回错误号，可以用来判断加锁失败之后的动作，可以有效的防止死锁

#### 5.加写锁

~~~c
int pthread_rwlock_wrlock(pthread_rwlock_t *rwlock);
~~~

-   参数
    -   rwlock：读写锁类型变量地址
-   返回值
    -   加锁成功返回0，失败返回错误号

调用这个函数，如果读写锁是打开的，那么加锁成功；如果读写锁已经锁定了读操作或者锁定了写操作，调用这个函数的线程会被阻塞

#### 6.尝试加写锁

~~~c
int pthread_rwlock_trywrlock(pthread_rwlock_t *rwlock);
~~~

调用这个函数，如果读写锁是打开的，那么加锁成功；如果读写锁已经锁定了读操作或者锁定了写操作，调用这个函数加锁失败，但是线程不会阻塞，可以在程序中对函数返回值进行判断，添加加锁失败之后的处理动作

#### 7.解锁

~~~c
int pthread_rwlock_unlock(pthread_rwlock_t *rwlock);
~~~

-   参数
    -   rwlock：读写锁类型变量地址
-   返回值
    -   解锁成功返回0，失败返回错误号

## 使用读写锁示例

~~~c
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>
#include <pthread.h>

//创建8个线程操作同一个全局变量，3个线程不定时写同一全局资源，5个线程不定时读同一全局资源

#define MAX 10

int number = 0;
pthread_rwlock_t rwlock;

void *readNum(void *arg)
{
	int i = 0;
	while(i<MAX)
	{
		pthread_rwlock_rdlock(&rwlock);
		printf("read  number = %d,tid = %ld\r\n",number,pthread_self());
		pthread_rwlock_unlock(&rwlock);
		usleep(rand()%100);
		i++;
	}
}

void *writeNum(void *arg)
{
	int i = 0;
	while(i<MAX)
	{
		pthread_rwlock_wrlock(&rwlock);
		int tmp = number;
		tmp++;
		number = tmp;
		printf("write number = %d,tid = %ld\r\n",number,pthread_self());
		pthread_rwlock_unlock(&rwlock);
		usleep(rand()%100);
		i++;
	}
}

int main()
{
	pthread_rwlock_init(&rwlock, NULL);
	pthread_t rtid[5];
	pthread_t wtid[3];
	for(int i = 0; i<5;i++)
	{
		pthread_create(&rtid[i],NULL,readNum,NULL);
	}
	for(int i = 0;i<3;i++)
        {
                pthread_create(&wtid[i],NULL,writeNum,NULL);
        }
	for(int i = 0; i<5;i++)
        {       
                pthread_join(rtid[i],NULL);
        }
        for(int i = 0;i<3;i++)
        {       
                pthread_join(wtid[i],NULL);
        }
	pthread_rwlock_destroy(&rwlock);
	return 0;
}
~~~

## 编译并执行测试程序

~~~shell
read  number = 0,tid = 140107297150528
read  number = 0,tid = 140107288757824
read  number = 0,tid = 140107280365120
read  number = 0,tid = 140107271972416
read  number = 0,tid = 140107263579712
write number = 1,tid = 140107255187008
write number = 2,tid = 140107246794304
write number = 3,tid = 140107238401600
read  number = 3,tid = 140107288757824
read  number = 3,tid = 140107280365120
read  number = 3,tid = 140107297150528
read  number = 3,tid = 140107271972416
read  number = 3,tid = 140107263579712
write number = 4,tid = 140107255187008
read  number = 4,tid = 140107288757824
read  number = 4,tid = 140107297150528
read  number = 4,tid = 140107280365120
read  number = 4,tid = 140107271972416
write number = 5,tid = 140107246794304
write number = 6,tid = 140107238401600
read  number = 6,tid = 140107297150528
read  number = 6,tid = 140107280365120
read  number = 6,tid = 140107288757824
read  number = 6,tid = 140107271972416
read  number = 6,tid = 140107263579712
write number = 7,tid = 140107255187008
read  number = 7,tid = 140107297150528
read  number = 7,tid = 140107280365120
read  number = 7,tid = 140107288757824
read  number = 7,tid = 140107271972416
write number = 8,tid = 140107246794304
write number = 9,tid = 140107238401600
read  number = 9,tid = 140107263579712
read  number = 9,tid = 140107288757824
read  number = 9,tid = 140107280365120
read  number = 9,tid = 140107297150528
read  number = 9,tid = 140107271972416
write number = 10,tid = 140107255187008
write number = 11,tid = 140107246794304
write number = 12,tid = 140107238401600
read  number = 12,tid = 140107280365120
read  number = 12,tid = 140107297150528
read  number = 12,tid = 140107271972416
read  number = 12,tid = 140107288757824
read  number = 12,tid = 140107263579712
write number = 13,tid = 140107255187008
read  number = 13,tid = 140107288757824
read  number = 13,tid = 140107271972416
read  number = 13,tid = 140107297150528
read  number = 13,tid = 140107280365120
write number = 14,tid = 140107246794304
write number = 15,tid = 140107238401600
read  number = 15,tid = 140107263579712
read  number = 15,tid = 140107297150528
read  number = 15,tid = 140107288757824
read  number = 15,tid = 140107280365120
read  number = 15,tid = 140107271972416
write number = 16,tid = 140107246794304
write number = 17,tid = 140107255187008
read  number = 17,tid = 140107288757824
read  number = 17,tid = 140107280365120
read  number = 17,tid = 140107263579712
read  number = 17,tid = 140107297150528
read  number = 17,tid = 140107271972416
write number = 18,tid = 140107238401600
write number = 19,tid = 140107246794304
read  number = 19,tid = 140107263579712
write number = 20,tid = 140107255187008
write number = 21,tid = 140107246794304
write number = 22,tid = 140107238401600
read  number = 22,tid = 140107263579712
write number = 23,tid = 140107255187008
write number = 24,tid = 140107246794304
read  number = 24,tid = 140107263579712
write number = 25,tid = 140107238401600
write number = 26,tid = 140107255187008
write number = 27,tid = 140107238401600
write number = 28,tid = 140107246794304
write number = 29,tid = 140107255187008
write number = 30,tid = 140107238401600
~~~


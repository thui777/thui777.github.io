---
title: 线程取消
categories: [linux,线程]
---

------

## 线程取消函数

线程取消的含义是在满足某些条件下在一个线程中杀死另一个线程，使用线程取消函数杀死一个线程需要分为两步：

1. 在线程A中调用线程取消函数pthread_cancel，指定杀死线程B，此时线程B还没有死
2. 在线程B中进行系统调用时（用户区切换到内核区），线程B此时被杀死，如果线程B一直得不到系统调用，那么线程B可以一直运行

线程取消函数原型：

~~~c
#include <pthread.h>

int pthread_cancel(pthread_t thread);
~~~

- 参数
  - thread：要杀死的线程ID
- 返回值
  - 函数调用成功返回0，调用失败返回错误号

## 线程取消示例

~~~c
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>
#include <pthread.h>

void *callback(void *arg)
{
    int i = 0;
    while(i<5)
    {
        i++;
    }
    //printf函数会间接的进行系统调用，线程运行到这里就被杀死了
    printf("我是子线程，线程ID：%ld，得到系统调用，子线程被杀死\r\n",pthread_self());
    return NULL;
}

int main()
{
    pthread_t tid;
    pthread_create(&tid, NULL, callback, NULL);

    printf("子线程创建成功, 线程ID：%ld\n", tid);
    printf("我是主线程, 线程ID：%ld\n", pthread_self());
   	int i = 0;
    while(i<5)
    {
        i++;
        printf("主线程运行中，i = %d\r\n",i);
    }
    pthread_exit(NULL);
    return 0;
}
~~~

## 编译并执行测试程序

~~~shell
子线程创建成功，线程ID：140686659323456
我是主线程，线程ID：140686659327808
主线程运行中，i = 1
主线程运行中，i = 2
主线程运行中，i = 3
主线程运行中，i = 4
主线程运行中，i = 5
我是子线程，线程ID：140686659323456，得到系统调用，子线程被杀死
~~~
